name: Terraform Drift Detection

on:
  schedule:
    - cron: '0 */6 * * *'  # Run every 6 hours
  workflow_dispatch:       # Allow manual trigger

jobs:
  drift_scan:
    name: Run Drift Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write        # Required to create issues on drift

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f drift-detector/requirements.txt ]; then pip install -r drift-detector/requirements.txt; fi

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Create Config Files
        run: |
          mkdir -p config
          echo "AWS_REGION=${{ secrets.AWS_REGION || 'us-east-1' }}" >> config/.env
          echo "SLACK_WEBHOOK_URL=${{ secrets.SLACK_WEBHOOK_URL }}" >> config/.env
          echo "SNS_TOPIC_ARN=${{ secrets.SNS_TOPIC_ARN }}" >> config/.env
          echo "DYNAMODB_TABLE=terraform-drift-history" >> config/.env

      - name: Run Drift Detector
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python enhanced_drift_detector.py \
            --environment dev \
            --terraform-dir ./terraform/environments/dev \
            --no-notify

      - name: Upload Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: drift-report-${{ github.run_number }}
          path: reports/
          retention-days: 7

      - name: Check for Drift
        id: drift_check
        if: always()
        run: |
          if [ -f reports/index.html ]; then
            # Check if drift was detected (exit code 1 means drift found)
            echo "drift_detected=true" >> $GITHUB_OUTPUT
          else
            echo "drift_detected=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Issue on Drift
        if: steps.drift_check.outputs.drift_detected == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportExists = fs.existsSync('reports/index.html');
            
            if (reportExists) {
              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸš¨ Infrastructure Drift Detected',
                body: `Drift was detected during automated scan.
                
                **Run:** #${{ github.run_number }}
                **Environment:** dev
                **Timestamp:** ${{ github.event.repository.updated_at }}
                
                Check the workflow artifacts for the detailed HTML report.
                
                [View Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`,
                labels: ['drift-detection', 'infrastructure']
              });
            }

name: Drift Detection

on:
  # Scheduled to run every 6 hours
  schedule:
    - cron: '0 */6 * * *'

  # Allow manual trigger
  workflow_dispatch:

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  TF_VERSION: '1.6.0'

jobs:
  detect-drift:
    name: Detect Configuration Drift
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        working-directory: drift-detector
        run: |
          pip install -r requirements.txt

      - name: Run Drift Detection
        working-directory: drift-detector
        run: |
          python main.py
        continue-on-error: true
        id: drift

      - name: Upload Drift Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: drift-reports
          path: drift-detector/reports/
          retention-days: 30

      - name: Create Issue if Drift Detected
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const output = `Configuration drift was detected in the infrastructure.

            Action Required: Review the drift detection reports and run \`terraform apply\` to restore the desired state.

            Artifacts: Check the workflow run artifacts for detailed drift reports.

            Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Configuration Drift Detected!',
              body: output,
              labels: ['drift-detection', 'infrastructure', 'urgent']
            });